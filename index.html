<!doctype html>
<html>
<head>
    <title>공간정보플랫폼</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <link rel="stylesheet" href="./index.css" />

    <!-- 지도API -->
    <link rel="stylesheet" type="text/css" href="http://map.seoul.go.kr/smgis/apps/mapsvr.do?cmd=gisMapCss">
    <script type="text/javascript" src="http://map.seoul.go.kr/smgis/apps/mapsvr.do?cmd=gisMapJs&key=523b6473492149d38c087b5d7e7531f9"></script>
    <script type="text/javascript" src="./js/ejs.min.js"></script>
    <script type="text/javascript" src="./js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">

    <script type="text/javascript">
        let	map = null;
        let poiList = null;
        let markers = [];

        const init = function(){
            map = L.map('map_', {
                continuousWorld: true
                ,worldCopyJump: false
                ,zoomControl: false
                ,zoomAnimation: true
                ,fadeAnimation : true
                ,inertia : false
                ,closePopupOnClick : false
                ,attributionControl : false //- 로고
            });
            poiList = document.getElementById('poi-list');

            fetch('./map_markers.json', {mode: "cors"}).then((response) => response.json()).then((data) => setMarkers(data.sort((a, b) => a.id - b.id)));

        };// end init

        const setMarkers = async function(data) {
            if (data.length < 1) return;
            markers = data;
            const firstEntry = data[0];
            map.setView([firstEntry.lat, firstEntry.lng], 10);
            BaseMapChange(map, L.Dawul.BASEMAP_GEN);

            const scaleBar = new L.Control.Scale({position:'bottomright'});
            map.addControl(scaleBar);

            const slider = new L.Control.Zoomslider({position:'topright'});
            map.addControl(slider);

            for (const idx in data) {
                const entry = data[idx];
                const marker = new L.Marker(new L.LatLng(entry.lat, entry.lng), {icon:new L.Icon({iconUrl:'./marker-icon-2x.png',iconSize:new L.Point(20,30)})}).addTo(map);
                const popupContent = ejs.render(`
                    <div class="col-9"><h5><%= entry.id %>동 <%= entry.title %></h5></div>
                    <% if (entry.warnings) { %>
                        <ul>
                        <% for (const warning of entry.warnings) { %>
                            <li><%= warning %></li>
                        <% } %>
                        </ul>
                    <% } %>
                `, {entry: entry});
                const customOptions = {
                    "offset": [0, -10]
                };
                marker.bindPopup(popupContent, customOptions);

                poiList.innerHTML += ejs.render(`
                    <button type="button" class="list-group-item list-group-item-action " onclick="moveAndOpen(${idx})">
                        <b><%= entry.id %>동 <%= entry.title %></b>
                        <br/>
                        <% if (entry.warnings) { %>
                            <ul>
                            <% for (const warning of entry.warnings) { %>
                                <li><%= warning %></li>
                            <% } %>
                            </ul>
                        <% } %>
                        <span class="text-muted"><%= Number(entry.lat).toFixed(6) %>, <%= Number(entry.lng).toFixed(6) %></span>
                    </button>
                `, {entry: entry});
                markers[idx].marker = marker
            }
        }

        const moveAndOpen = (idx) => {
            const target = markers[idx]
            map.setView([target.lat, target.lng], 14)
            target.marker.openPopup()
        }
    </script>
<body onload="init()">

<div id="map_"></div>
<div class="position-absolute top-0 end-0 bottom-0 d-inline-block">
    <div class="position-fixed top-0 end-0 bottom-0 list-group list-group-flush" id="poi-list">

    </div>
</div>


</body>
</html>